# Support Triage Copilot

A local-first, headless triage and drafting bot with closed-loop learning. Runs entirely on your machine (Ollama for LLM + embeddings, SQLite/IMAP for queue and feedback).

Quick links:
- Agent guide: `AGENT_GUIDE.md`
- Docs index: `docs/INDEX.md`
- Overviews: `docs/overview_en.md`, `docs/overview_fi.md`
- Design + runbook: `DESIGN.md`, `RUNBOOK.md`, `docs/specs/*`

## Quick start
- `cp .env.example .env` and fill IMAP + Ollama settings.
- Docker: `docker compose up -d --build`
- Manual: `python tools/daemon.py` (requires Ollama running).
- Health: `python tools/status.py` (check “Last Triage” and “Drafts Waiting”).

Env essentials (.env):
- `TRIAGE_MODE=llm`, `MODEL_NAME=llama3.1:8b`, `OLLAMA_HOST=http://ollama:11434`, `OLLAMA_EMBED_MODEL=nomic-embed-text`
- `TOOL_SELECT_MODE=llm`
- IMAP: `IMAP_HOST`, `IMAP_USERNAME`, `IMAP_PASSWORD`, `IMAP_FOLDER_DRAFTS`, `IMAP_FOLDER_SENT`
- `KNOWLEDGE_SOURCE=./data/knowledge.md` (or your own markdown/CSV/XLS key/value table)
- `DB_PATH=/data/queue.db`

## Core workflow (SQLite queue)
- Ingest email/text into the queue (`/triage/enqueue`, `python tools/ingest_eml.py`, or `python tools/imap_ingest_db.py --watch`).
- Triage with LLM/heuristic; suggest tools, draft replies, and store audit trails.
- Evidence + drafts sync via `tools/daemon.py` (scheduler for ingest/triage/draft sync/sent feedback/learning).
- Approvals remain human-in-the-loop (no auto-send).

## Daily operator flow
- Start worker: `python tools/triage_worker.py --watch` (or run daemon).
- Open UI: `streamlit run ui/app.py`.
- Handle queue: review triage + evidence + drafts.
- Approve/rewrite/escalate; edits persist in the DB and can sync to Drafts via daemon.
- Optional: enable pipeline extension with `FEATURE_PIPELINE=1` for demo-only pipeline tools.

Golden path (no IMAP required):
- `python tools/replay_intakes.py --from tests/scenarios --into data/queue.db`
- `python tools/triage_worker.py --watch`
- `python tools/sync_drafts.py --limit 10`

Primary commands:
- `python tools/daemon.py` — supervise ingest/triage/draft sync/sent feedback/learning
- `python tools/triage_worker.py` — run triage loop against the SQLite queue
- `python tools/status.py` — heartbeat/queue depth check
- `python tools/run_learning_cycle.py` — force a learning cycle
- `python tools/verify_learning.py` — validate few-shot retrieval (set `TRIAGE_MODE=llm` first)
- API enqueue example:  
  `curl -X POST http://localhost:8000/triage/enqueue -H "Content-Type: application/json" -H "X-API-KEY: ${INGEST_API_KEY}" -d '{"text":"Emails are bouncing to contoso.com","tenant":"acme"}'`

## Documentation map
- Agent workflow: `AGENT_GUIDE.md`
- System overview & contract: `docs/overview_en.md`, `docs/contract.md`
- Design + runbook: `DESIGN.md`, `RUNBOOK.md`
- Specs: `docs/specs/FEEDBACK_LOOP.md`, `docs/specs/DYNAMIC_FEW_SHOT.md`
- Index + legacy pointers: `docs/INDEX.md`, `docs/LEGACY.md`

## Data & artifacts
- `data/queue.db` (default), IMAP drafts/sent mirrors, and sample knowledge live under `data/`.
- Outputs and demo exports (e.g., `data/demo_run/*`) are generated by scripts like `tools/one_run.py`.

## Legacy / archived
- Legacy chatbot + Excel queue code is archived under `legacy/` (chat worker/dispatcher, Excel queue worker, legacy tests).
- Archived docs moved to `docs/legacy/`; follow `docs/LEGACY.md` for details.
- Optional “pipeline” demo lives under `app/extensions/pipeline` and is OFF by default. Enable with `FEATURE_PIPELINE=1` if you need the older pipeline scoring/XLSX history; pipeline tools/tests require that flag and pandas/openpyxl (not needed for core triage).

Notes:
- Keep the Internal Ref footer in drafts/sent mail for closed-loop linking.
- Knowledge loader accepts any key/value content; point `KNOWLEDGE_SOURCE` at your own file.
